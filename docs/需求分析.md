# 书店管理系统需求分析

## 业务流图

本系统的核心业务如图所示，其中字母表示节点，{}内的内容表示判断，[]内的内容表示执行的操作

```
//系统启动
A[系统启动] -> B{初始化检查}
B - 是首次运行 -> C[创建超级管理员账户]
B - 非首次运行 -> D[等待输入命令]
C -> D

D -> E{输入指令}

//顾客操作
E - 账户操作(su/register) -> F[权限验证 & 登录栈push]
E - 退出登录(logout) -> G[登录栈pop]
E - 图书查询(show) -> H[检索图书索引文件]
E - 购买(buy) -> I[更新库存 & 记录交易日志]
E - 选书(select) -> J[记录当前选中ISBN]

//销售操作
E - 销售/店长操作 -> K{权限检查}
K - 进货(import) -> L[更新库存 & 记录成本]
K - 修改(modify) -> M[更新图书信息文件]
K - 用户管理(useradd/delete) -> N[更新用户文件]

//店长操作
E - 店长操作 -> O{权限检查}
O - 日志查询(log/report) -> P[读取并格式化日志文件]

//指令处理结束，重新输入
F -> D
G -> D
H -> D
I -> D
J -> D
L -> D
M -> D
N -> D
P -> D
```

## 数据流图

本系统的数据流如图所示，||内的内容表示数据，()内的内容表示文件

```
User[用户] ->|指令| Parser[命令解析模块]

Parser ->|账户指令| Auth[用户管理模块]
Parser ->|图书指令| Book[图书管理模块]
Parser ->|日志指令| Log[日志管理模块]

Auth <->|读写| UserFile[(用户数据)]

Book ->|选中图书| Session[当前会话]
Book <->|读写| BookFile[(图书数据)]

Book ->|交易数据| Log
Log <->|读写| LogFile[(日志)]

Auth ->|操作结果| Display[输出显示]
Book ->|查询结果| Display
Log ->|报表数据| Display

Display -> User
```

## 数据词典

本系统主要涉及以下数据实体。为满足性能需求，数据项设计需考虑文件存储格式（如定长或分隔符）。

### 图书 (Book)

| 数据项   | 类型         | 长度/范围 | 含义         | 备注                   |
| -------- | ------------ | --------- | ------------ | ---------------------- |
| ISBN     | 字符串       | 20 Byte   | 国际标准书号 | 唯一标识，按照国际标准 |
| BookName | 字符串       | 60 Byte   | 书名         |                        |
| Author   | 字符串       | 60 Byte   | 作者         |                        |
| Keyword  | 字符串的集合 | 60 Byte   | 关键字       | 可能有多个关键字       |
| Quantity | 整型         | 4 Byte    | 库存量       | ≥ 0                    |
| Price    | 浮点型       | 8 Byte    | 单价         | 非负                   |

### 用户 (User)

| 数据项    | 类型   | 长度/范围 | 含义     | 备注                           |
| --------- | ------ | --------- | -------- | ------------------------------ |
| UserID    | 字符串 | 30 Byte   | 账户ID   | 唯一标识，由数字字母下划线组成 |
| Password  | 字符串 | 30 Byte   | 密码     |                                |
| Username  | 字符串 | 30 Byte   | 用户昵称 |                                |
| Privilege | 整型   | 0-7       | 权限等级 | 1=顾客, 3=销售, 7=店长         |

### 日志 (Log)

| 数据项      | 类型   | 含义     | 备注                     |
| ----------- | ------ | -------- | ------------------------ |
| Date        | 字符串 | 操作时间 | 格式 YYYY-MM-DD HH:MM:SS |
| Type        | 枚举   | 操作类型 | 进货、销售、支出、收入   |
| Target_ISBN | 字符串 | 涉及图书 |                          |
| Count       | 整型   | 数量     |                          |
| Amount      | 浮点型 | 总金额   |                          |
| OperatorID  | 字符串 | 操作人ID |                          |

## 功能说明与交互设计

以下所有**输出**默认指令合法且操作成功，如果指令不合法或操作不成功，输出 `Invalid`。

### 系统模块

1. **功能名称：初始化**
   - **输入**：无（程序启动自动执行）
   - **所做的处理**：检查用户存储文件是否存在。若不存在，提示创建超级管理员（店长）账户。
   - **输出**：系统启动提示或超级管理员创建成功提示。
2. **功能名称：退出系统 (exit/quit)**
   - **输入**：指令 `exit` 或 `quit`
   - **所做的处理**：终止程序运行，确保文件流正确关闭。
   - **输出**：无。

### 用户管理模块

1. **功能名称：登录 (su)**
   - **输入**：`[UserID]`, `[Password]` (可选)
   - **所做的处理**：
     - 验证账号密码。
     - 若成功，将新用户 push 进登录栈，提升当前权限。
     - 若未提供密码且当前登录用户权限 > 目标用户权限，则免密登录。
   - **输出**：登录成功/失败提示。
2. **功能名称：注销 (logout)**
   - **输入**：无
   - **所做的处理**：将当前用户从登录栈 pop，恢复到上一层用户的状态。若栈空则无法注销。
   - **输出**：无。
3. **功能名称：注册 (register)**
   - **输入**：`[UserID]`, `[Password]`, `[Username]`
   - **所做的处理**：创建新用户，默认权限为 1 (顾客)。
   - **输出**：注册成功/失败（ID冲突）提示。
4. **功能名称：创建用户 (useradd)**
   - **权限**：销售人员及以上（创建权限 < 当前权限的用户）
   - **输入**：`[UserID]`, `[Password]`, `[Privilege]`, `[Username]`
   - **所做的处理**：创建指定权限的用户。
   - **输出**：创建结果。
5. **功能名称：修改密码 (passwd)**
   - **权限**：店长（可改任意用户），或用户（可改自己）
   - **输入**：`[UserID]`, `[CurrentPassword]`, `[NewPassword]`
   - **所做的处理**：验证旧密码（店长操作可跳过），更新存储。
   - **输出**：修改结果。

### 图书管理模块

1. **功能名称：查询图书 (show)**
   - **权限**：所有用户
   - **输入**：参数组合 `-ISBN=[id]`, `-name="[name]"`, `-author="[author]"`, `-keyword="[key]"`，或无参数（显示所有）。
   - **所做的处理**：
     - 无参数：按ISBN字典序输出所有非空图书。
     - 有参数：根据索引文件快速查找匹配图书，按ISBN排序。
   - **输出**：图书列表（ISBN, 名称, 作者, 关键字, 价格, 库存）。
2. **功能名称：购买图书 (buy)**
   - **权限**：所有用户
   - **输入**：`[ISBN]`, `[Quantity]`
   - **所做的处理**：检查库存是否充足。若充足，扣减库存，增加系统收入，记录销售日志。
   - **输出**：购买成功提示及总价。
3. **功能名称：选中图书 (select)**
   - **权限**：销售人员及以上
   - **输入**：`[ISBN]`
   - **所做的处理**：将指定ISBN设为“当前选中图书”。若ISBN不存在，则新建一个空条目（待后续录入信息）。
   - **输出**：无。
4. **功能名称：修改图书信息 (modify)**
   - **权限**：销售人员及以上
   - **前置条件**：必须先执行 `select`
   - **输入**：参数组合 `-ISBN=[new]`, `-name="[new]"`, `-author="[new]"`, `-keyword="[new]"`, `-price=[new]`
   - **所做的处理**：更新“当前选中图书”的字段信息。若修改了ISBN，需检查新ISBN唯一性。关键字不能重复。
   - **输出**：无。
5. **功能名称：图书进货 (import)**
   - **权限**：销售人员及以上
   - **前置条件**：必须先执行 `select`
   - **输入**：`[Quantity]`, `[TotalCost]` (总进货价)
   - **所做的处理**：增加当前选中图书的库存，记录系统支出（成本），记录进货日志。
   - **输出**：无。

### 日志管理模块 (店长专用)

1. **功能名称：查询财务报表 (report finance)**
   - **权限**：店长
   - **输入**：无
   - **所做的处理**：遍历交易日志，计算总收入、总支出，得出利润。
   - **输出**：收入、支出、利润统计。
2. **功能名称：查询员工工作情况 (report employee)**
   - **权限**：店长
   - **输入**：无（或指定员工ID，根据具体需求）
   - **所做的处理**：输出所有员工的操作记录。
   - **输出**：操作日志列表。
3. **功能名称：查看系统日志 (log)**
   - **权限**：店长
   - **输入**：无
   - **所做的处理**：输出系统整体工作日志。
   - **输出**：日志列表。